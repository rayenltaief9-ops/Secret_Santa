<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secret Santa 2025 üéÑ</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #050b10;
      --card: #111827;
      --accent: #e11d48;
      --accent-light: #f472b6;
      --gold: #facc15;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: rgba(148, 163, 184, 0.4);
      --error: #f87171;
      --success: #4ade80;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 0 0, #22c55e22 0, transparent 55%),
        radial-gradient(circle at 100% 100%, #f9731622 0, transparent 55%),
        radial-gradient(circle at 50% 0, #0ea5e922 0, transparent 45%),
        var(--bg);
    }

    .card {
      width: min(480px, 100%);
      background: var(--card);
      border-radius: 22px;
      padding: 22px 20px 24px;
      border: 1px solid var(--border);
      box-shadow:
        0 18px 40px rgba(0, 0, 0, 0.8),
        0 0 0 1px rgba(15, 23, 42, 0.6);
    }

    .card-header {
      text-align: center;
      margin-bottom: 16px;
    }

    .title-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    h1 {
      margin: 0;
      font-size: 1.7rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      background: linear-gradient(120deg, #fee2e2, #fed7aa);
      -webkit-background-clip: text;
      color: transparent;
    }

    .subtitle {
      margin-top: 4px;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--muted);
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #4ade80, #16a34a);
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.3);
    }

    label {
      font-size: 0.85rem;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    .select-row {
      display: flex;
      gap: 8px;
      margin-bottom: 14px;
    }

    .select-wrapper {
      position: relative;
      flex: 1;
    }

    select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-family: inherit;
      font-size: 0.9rem;
      outline: none;
      appearance: none;
    }

    select:focus {
      border-color: var(--accent-light);
      box-shadow: 0 0 0 1px rgba(236, 72, 153, 0.7);
    }

    .select-wrapper::after {
      content: "‚ñæ";
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.75rem;
      color: var(--muted);
      pointer-events: none;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 10px 15px;
      font-size: 0.9rem;
      font-family: inherit;
      font-weight: 600;
      background: linear-gradient(135deg, var(--accent), #7f1d1d);
      color: #f9fafb;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 20px rgba(127, 29, 29, 0.7);
      transition: transform 0.1s ease-out, box-shadow 0.1s ease-out, filter 0.1s ease-out;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 14px 26px rgba(127, 29, 29, 0.9);
    }

    button:active:not(:disabled) {
      transform: translateY(0) scale(0.98);
      box-shadow: 0 8px 16px rgba(127, 29, 29, 0.8);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .slot-box {
      margin-top: 4px;
      border-radius: 18px;
      padding: 10px 10px 12px;
      background: radial-gradient(circle at 0 0, #111827, #020617);
      border: 1px solid rgba(30, 64, 175, 0.8);
      box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    .slot-label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 4px;
    }

    .slot-window {
      border-radius: 12px;
      background: #020617;
      padding: 10px;
      text-align: center;
    }

    .slot {
      font-size: 1.6rem;
      letter-spacing: 0.1em;
      font-weight: 700;
      color: var(--gold);
      text-shadow: 0 0 10px rgba(250, 204, 21, 0.7);
      min-height: 2.1em;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slot.spinning {
      animation: spin 0.14s linear infinite;
    }

    @keyframes spin {
      0% { transform: translateY(0); }
      25% { transform: translateY(-3px); }
      50% { transform: translateY(0); }
      75% { transform: translateY(3px); }
      100% { transform: translateY(0); }
    }

    .msg {
      margin-top: 10px;
      min-height: 32px;
      font-size: 0.86rem;
      color: var(--muted);
      text-align: center;
    }

    .msg.error {
      color: var(--error);
    }

    .msg.success {
      color: var(--success);
    }

    .footer {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--muted);
      text-align: center;
      opacity: 0.8;
    }

    @media (max-width: 480px) {
      .card {
        padding: 18px 14px 20px;
      }
      h1 {
        font-size: 1.5rem;
      }
      .slot {
        font-size: 1.4rem;
      }
    }
  </style>
</head>
<body>
  <main class="card">
    <header class="card-header">
      <div class="title-row">
        <span>üéÅ</span>
        <h1>Secret Santa 2025</h1>
        <span>üéÑ</span>
      </div>
      <div class="subtitle">
        9 friends, 9 gifts. Each device can roll for <strong>exactly one person</strong>.
      </div>
      <div class="badge">
        <span class="badge-dot"></span>
        <span>Lobby locked ¬∑ private game</span>
      </div>
    </header>

    <section>
      <label for="nameSelect">1. Choose who you are:</label>
      <div class="select-row">
        <div class="select-wrapper">
          <select id="nameSelect">
            <option value="">Pick your name‚Ä¶</option>
            <option value="alice">Alice</option>
            <option value="rayen">Rayen</option>
            <option value="hannagh">Hannagh</option>
            <option value="martina">Martina</option>
            <option value="sasha">Sasha</option>
            <option value="will">Will</option>
            <option value="fabi">Fabi</option>
            <option value="arian">Arian</option>
            <option value="ayumi">Ayumi</option>
          </select>
        </div>
        <button id="rollBtn">
          <span>üé∞</span>
          <span>Roll</span>
        </button>
      </div>
    </section>

    <section class="slot-box">
      <div class="slot-label">your secret target</div>
      <div class="slot-window">
        <div id="slot" class="slot">????</div>
      </div>
    </section>

    <div id="msg" class="msg">
      Pick your name and hit <strong>Roll</strong>. The result is saved on this device.
    </div>

    <div class="footer" id="deviceInfo"></div>
  </main>

  <script>
    const DISPLAY_NAMES = ["Alice","Rayen","Hannagh","Martina","Sasha","Will","Fabi","Arian","Ayumi"];
    const API_URL = "/api/target";
    const STORAGE_NAME_KEY = "ss25_name";
    const STORAGE_TARGET_KEY = "ss25_target";

    const nameSelect = document.getElementById("nameSelect");
    const rollBtn = document.getElementById("rollBtn");
    const slot = document.getElementById("slot");
    const msg = document.getElementById("msg");
    const deviceInfo = document.getElementById("deviceInfo");

    let spinInterval = null;
    let isSpinning = false;

    function setMessage(text, type = "") {
      msg.classList.remove("error", "success");
      if (type) msg.classList.add(type);
      msg.innerHTML = text;
    }

    function setDeviceInfo(text) {
      deviceInfo.textContent = text || "";
    }

    function startSpinner() {
      let i = 0;
      if (spinInterval) clearInterval(spinInterval);
      slot.classList.add("spinning");
      spinInterval = setInterval(() => {
        slot.textContent = DISPLAY_NAMES[i % DISPLAY_NAMES.length].toUpperCase();
        i++;
      }, 90);
      isSpinning = true;
    }

    function stopSpinner(finalText) {
      if (spinInterval) {
        clearInterval(spinInterval);
        spinInterval = null;
      }
      setTimeout(() => {
        slot.classList.remove("spinning");
        if (finalText) {
          slot.textContent = finalText.toUpperCase();
        }
        isSpinning = false;
      }, 320);
    }

    function lockDeviceTo(name, target) {
      localStorage.setItem(STORAGE_NAME_KEY, name);
      localStorage.setItem(STORAGE_TARGET_KEY, target);
      nameSelect.value = name;
      nameSelect.disabled = true;
      rollBtn.disabled = true;
      const prettyTarget = target.charAt(0).toUpperCase() + target.slice(1);
      setMessage(
        `This device is now locked to <strong>${capitalize(name)}</strong>.<br>Your target is <strong>${prettyTarget}</strong>.`,
        "success"
      );
      setDeviceInfo("If you change device or browser, you‚Äôll get the same name again (server remembers).");
    }

    function capitalize(s) {
      return s.charAt(0).toUpperCase() + s.slice(1);
    }

    // Restore previous roll if exists
    (function initFromStorage() {
      const storedName = localStorage.getItem(STORAGE_NAME_KEY);
      const storedTarget = localStorage.getItem(STORAGE_TARGET_KEY);
      if (storedName && storedTarget) {
        nameSelect.value = storedName;
        nameSelect.disabled = true;
        rollBtn.disabled = true;
        slot.textContent = storedTarget.toUpperCase();
        setMessage(
          `Welcome back, <strong>${capitalize(storedName)}</strong>!<br>Your Secret Santa target is still <strong>${capitalize(storedTarget)}</strong>.`,
          "success"
        );
        setDeviceInfo("This browser is already used by " + capitalize(storedName) + ".");
      }
    })();

    async function handleRoll() {
      const selected = nameSelect.value.trim().toLowerCase();

      if (!selected) {
        setMessage("Please choose your own name first üåü", "error");
        return;
      }

      const storedName = localStorage.getItem(STORAGE_NAME_KEY);
      const storedTarget = localStorage.getItem(STORAGE_TARGET_KEY);

      // Device already locked to someone
      if (storedName && storedName !== selected) {
        setMessage(
          `This device is already locked to <strong>${capitalize(storedName)}</strong>. You can‚Äôt roll for another person on the same phone.`,
          "error"
        );
        nameSelect.value = storedName;
        return;
      }

      if (storedName && storedName === selected && storedTarget) {
        setMessage(
          `You already rolled, <strong>${capitalize(storedName)}</strong>! Your target is <strong>${capitalize(storedTarget)}</strong>.`,
          "success"
        );
        return;
      }

      if (isSpinning) return;

      rollBtn.disabled = true;
      startSpinner();
      setMessage("Shuffling names in Santa‚Äôs database‚Ä¶ üéÖ");

      try {
        const res = await fetch(`${API_URL}?giver=${encodeURIComponent(selected)}`);
        const data = await res.json();

        if (!res.ok || data.error) {
          stopSpinner("????");
          rollBtn.disabled = false;

          if (data.error === "unknown_giver") {
            setMessage("Name not recognised by the server. Check the spelling list.", "error");
          } else if (data.error === "already_played") {
            setMessage(
              "This name has already rolled on the server. Use the same device you used the first time!",
              "error"
            );
          } else {
            setMessage("Server had a little panic. Try again later üîß", "error");
          }
          return;
        }

        const target = data.target || "????";
        const prettyTarget = capitalize(target);

        setTimeout(() => {
          stopSpinner(prettyTarget);
          lockDeviceTo(selected, target);
        }, 800);

      } catch (err) {
        console.error(err);
        stopSpinner("ERR");
        rollBtn.disabled = false;
        setMessage("Network error. Santa‚Äôs Wi-Fi died. Try again in a bit üì°", "error");
      }
    }

    rollBtn.addEventListener("click", handleRoll);
  </script>
</body>
</html>